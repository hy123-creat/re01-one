
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>数据录入与结果评估系统</title>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
           text-align: center; /* 标题居中 */
        }
        .factor {
            border: 1px solid #ddd;
            margin: 15px 0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .factor-header {
            position: relative;
            padding-right: 200px;
            cursor: pointer;
            background: #e3f2fd;
            display: flex;
            align-items: center;
        }
        .collapse-icon {
            margin-right: 10px;
            transition: transform 0.3s;
        }
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .subfactors {
            padding: 10px;
            display: block;
        }
        .subfactor {
            margin: 10px 0;
            padding: 15px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        input {
            width: 90px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }
        .total-box {
            background: #e8f5e9;
            padding: 10px;
            margin: 10px;
            position: absolute;
            right: 20px;
        }
        button {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
        .validity-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .validity-group input[type="number"] {
            width: 100px;
            background: #f0f0f0;            
        }
                /* 新增样式 */
                .planning-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .planning-group input[readonly] {
            background: #f0f0f0;
        }
        #submitBtn {
            display: block;
            margin: 20px auto;
        }
        #results {
            margin-top: 30px;
            padding: 40px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        .export-btn {
            background: #4CAF50;
        }
        .deepseek-btn {
            background: #9C27B0;
        }
        .calculation-group {
            display: flex;
            gap: 10px;
        }
        .calculation-group input[readonly] {
            background: #f0f0f0;
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>数据录入与结果评估</h1>
        
        <form id="evaluationForm">
            <!-- 方案的完备度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>方案的完备度（总权重：15%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <div class="subfactor">
                        <label>规划方案的合理性 <span class="weight">权重3%</span></label>
                        <div class="validity-group">
                            <!-- 选择框，带有文字说明 -->
                            <select class="validity-input" data-weight="0.03" onchange="updateWeightedScore(this)">
                                <option value="">请选择评分</option> 
                                <option value="0">0 - 无规划方案</option>
                                <option value="50">50 - 规划方案基本可行</option>
                                <option value="70">70 - 规划方案合理性较强</option>
                                <option value="100">100 - 规划方案合理性强</option>
                            </select>
                            
                            <!-- 计加权得分 -->
                            <input type="number" class="weighted" readonly placeholder="加权得分">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>实施方案的合理性 <span class="weight">权重3%</span></label>
                        <div class="validity-group">
                            <!-- 选择框，带有文字说明 -->
                            <select class="validity-input" data-weight="0.03" onchange="updateWeightedScore(this)">
                                <option value="">请选择评分</option> 
                                <option value="0">0 - 无实施方案</option>
                                <option value="50">50 - 实施方案基本可行</option>
                                <option value="70">70 - 实施方案合理性较强</option>
                                <option value="100">100 - 实施方案合理性强</option>
                            </select>
                            
                            <!-- 计加权得分 -->
                            <input type="number" class="weighted" readonly placeholder=加权得分>
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>管理方案的合理性 <span class="weight">权重3%</span></label>
                        <div class="validity-group">
                            <!-- 选择框，带有文字说明 -->
                            <select class="validity-input" data-weight="0.03" onchange="updateWeightedScore(this)">
                                <option value="">请选择评分</option> 
                                <option value="0">0 - 无管理方案</option>
                                <option value="50">50 - 管理方案基本可行</option>
                                <option value="70">70 - 管理方案合理性较强</option>
                                <option value="100">100 - 管理方案合理性强</option>
                            </select>
                            
                            <!-- 计加权得分 -->
                            <input type="number" class="weighted" readonly placeholder=加权得分>
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>供地方案的合理性 <span class="weight">权重3%</span></label>
                        <div class="validity-group">
                            <!-- 选择框，带有文字说明 -->
                            <select class="validity-input" data-weight="0.03" onchange="updateWeightedScore(this)">
                                <option value="">请选择评分</option> 
                                <option value="0">0 - 无供地方案</option>
                                <option value="50">50 - 供地方案基本可行</option>
                                <option value="70">70 - 供地方案合理性较强</option>
                                <option value="100">100 - 供地方案合理性强</option>
                            </select>
                            
                            <!-- 计加权得分 -->
                            <input type="number" class="weighted" readonly placeholder=加权得分>
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>招商方案的合理性 <span class="weight">权重3%</span></label>
                        <div class="validity-group">
                            <!-- 选择框，带有文字说明 -->
                            <select class="validity-input" data-weight="0.03" onchange="updateWeightedScore(this)">
                                <option value="">请选择评分</option> 
                                <option value="0">0 - 无招商方案</option>
                                <option value="50">50 - 招商方案基本可行</option>
                                <option value="70">70 - 招商方案合理性较强</option>
                                <option value="100">100 - 招商方案合理性强</option>
                            </select>
                            
                            <!-- 计加权得分 -->
                            <input type="number" class="weighted" readonly placeholder=加权得分>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 工作的衔接度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>工作的衔接度（总权重：18%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <!-- 修改后的前序工作干扰度 -->
                    <div class="subfactor">
                        <label>前序工作的干扰度 <span class="weight">权重3%</span></label>
                        <div class="calculation-group">
                            <span style="font-size: 16px; color: #242424; max-width: 400px; line-height: 2;">
                                纠纷天数：
                            </span>
                            <input type="number" data-custom="disputeDays" placeholder="天数" min="0">
                            <span style="font-size: 16px; color: #242424; max-width: 400px; line-height: 2;">
                                施工总天数：
                            </span>
                            <input type="number" data-custom="totalDays" placeholder="天数" min="1">
                            <input type="number" data-custom="calculated" readonly placeholder="得分" step="0.01">
                            <input type="number" data-custom="weighted" data-weight="0.03" readonly placeholder=加权得分 step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>相关规划衔接度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>资金保障的可靠度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
                                   onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>部门间的衔接度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>工序间的衔接度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>审批结果合格性 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!—工程的保障度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>工程的保障度（总权重：26%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <div class="subfactor">
                        <label>交通保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>给水保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>排水保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>供电保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>供暖保障度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>燃气保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>通讯保障度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>场地平整适宜度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!—理念先进度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>理念先进度（总权重：12%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <div class="subfactor">
                        <label>工程低碳度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>空间集约度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>管廊综合度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>创新技术应用率<span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>智慧管理覆盖率 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>智能设备使用率 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>    
                </div>
            </div>

            <!—效益的显著度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>效益的显著度（总权重：9%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <div class="subfactor">
                        <label>经济效益显著度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>社会效益显著度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>生态效益显著度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!—安全的可靠度 -->
            <div class="factor">
                <div class="factor-header" onclick="toggleFactor(this)">
                    <svg class="collapse-icon" width="12" height="12" viewBox="0 0 24 24">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                    </svg>
                    <h2>安全的可靠度（总权重：20%）</h2>
                    <div class="total-box">本指标得分：0.00</div>
                </div>
                <div class="subfactors">
                    <div class="subfactor">
                        <label>管理抗风险度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>地质灾害防治度<span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>洪涝灾害防治度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>土壤污染修复度 <span class="weight">权重3%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.03"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>生态环境扰动度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>土地管理有效度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>安全措施得当度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                    <div class="subfactor">
                        <label>安全事故危害度 <span class="weight">权重2%</span></label>
                        <div class="planning-group">
                            <input type="number" 
                                   data-weight="0.02"
                                   data-formula="direct" 
                                   placeholder="总分"
                                   min="0" max="100"
                                   step="0.01"
               onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 46">
                            <input type="number" 
                                   data-custom="weighted" 
                                   readonly 
                                   placeholder=加权得分
                                   step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit">计算综合评分</button>
        </form>

        <div id="results">
            <div id="factorScores"></div>
            <div id="totalScore"></div>
        </div>
                <!-- 新增按钮容器 -->
                <div class="action-buttons">
                    <button class="btn btn-add" onclick="exportToExcel()">导出Excel</button>
                    <button type="button" class="deepseek-btn" onclick="gotoDeepseek()">深度分析</button>
                        <!-- 提示文字 -->
                    <span style="font-size: 14px; color: #555; max-width: 400px; line-height: 1.5;">
                        请将导出的 Excel 表和以下文字：每一项指标实际得分的总分均为 100 分，请总结得分的总体情况，分项情况，以及如何改进整治工作，能够使得整治得分更高。输入到deepseek的对话框。
                    </span>
                </div>
                
    </div>

    <script>
        // 展开/收起功能
        function toggleFactor(header) {
            const factor = header.parentElement;
            factor.classList.toggle('collapsed');
            const subfactors = factor.querySelector('.subfactors');
            subfactors.style.display = factor.classList.contains('collapsed') ? 'none' : 'block';
        }
    
        // 通用指标得分计算函数
        function calculateFactorTotal(factor) {
            let total = 0;
            
            // 查找当前指标下所有类型加权得分输入框
            factor.querySelectorAll('[data-custom="weighted"], .weighted').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
    
            // 更新指标总分显示
            const totalBox = factor.querySelector('.total-box');
            if(totalBox) {
                totalBox.textContent = `本指标得分：${total.toFixed(2)}`;
                totalBox.style.color = total > 0 ? '#2e7d32' : '#d32f2f';
            }
        }
    
        // === 各类型输入处理函数 ===
        function updateWeightedScore(select) {
            const weight = parseFloat(select.dataset.weight); // 获取权重
            const selectedOption = select.options[select.selectedIndex]; // 获取选中的 option 元素
            const score = selectedOption.value; // 获取数字部分，只有 value 部分
            const weightedScore = score ? (parseFloat(score) * weight).toFixed(2) : ""; // 计算得分

            const weightedInput = select.closest('.validity-group').querySelector('.weighted'); // 找到对应加权得分输入框
            weightedInput.value = weightedScore; // 设置计算后的得分，仅显示数字
                // **立即更新一级指标得分**
            calculateFactorTotal(select.closest('.factor'));
        }
        
 
        // 2. 前序工作干扰度计算
        function calculateInterference(input) {
            const parent = input.closest('.subfactor');
            const disputeDays = parseFloat(parent.querySelector('[data-custom="disputeDays"]').value) || 0;
            const totalDays = parseFloat(parent.querySelector('[data-custom="totalDays"]').value) || 1;
            const calculated = ((totalDays - disputeDays) / totalDays) * 100;
    
            parent.querySelector('[data-custom="calculated"]').value = calculated.toFixed(1);
            const weighted = calculated * 0.03; // 权重3%
            parent.querySelector('[data-custom="weighted"]').value = weighted.toFixed(2);
            
            calculateFactorTotal(input.closest('.factor'));
        }
    
        // 3. 直接计算类型处理
        function calculateDirectScore(input) {
            const parent = input.closest('.subfactor');
            const value = parseFloat(input.value) || 0;
            const weight = parseFloat(input.dataset.weight);
            const weighted = parent.querySelector('[data-custom="weighted"]');
            
            weighted.value = (value * weight).toFixed(2);
            calculateFactorTotal(input.closest('.factor'));
        }
    
        // === 事件监听 ===
        // 绑定所有输入类型
        document.querySelectorAll('input').forEach(input => {
            // 方案完备度专用验证
            if(input.classList.contains('validity-input')) {
                input.addEventListener('input', () => validateValidity(input));
            }
            // 前序工作干扰度计算
            else if(input.dataset.custom === 'disputeDays' || input.dataset.custom === 'totalDays') {
                input.addEventListener('input', () => calculateInterference(input));
            }
            // 直接计算类型
            else if(input.dataset.formula === 'direct') {
                input.addEventListener('input', () => calculateDirectScore(input));
            }
        });
    
        // === 初始化计算 ===
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.factor').forEach(factor => {
                calculateFactorTotal(factor);
            });
        });
    
        // === 综合评分计算 ===
        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let totalScore = 0;
            const results = [];
    
            document.querySelectorAll('.factor').forEach(factor => {
                const factorName = factor.querySelector('h2').textContent;
                const scoreText = factor.querySelector('.total-box').textContent;
                const factorScore = parseFloat(scoreText.replace('本指标得分：', '')) || 0;
    
                totalScore += factorScore;
                results.push(`
                    <div class="factor-result">
                        <h3>${factorName}</h3>
                        <div>小计：${factorScore.toFixed(2)}</div>
                    </div>
                `);
            });
    
            document.getElementById('factorScores').innerHTML = results.join('');
            document.getElementById('totalScore').innerHTML = `<h3>总评分：${totalScore.toFixed(2)}</h3>`;
        });
                // 综合评分计算（增加二级指标详情）
                document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let totalScore = 0;
            const results = [];
            
            document.querySelectorAll('.factor').forEach(factor => {
                const factorName = factor.querySelector('h2').textContent;
                let factorScore = 0;
                let subItems = [];
                
                // 遍历所有输入项
                factor.querySelectorAll('.subfactor').forEach(sub => {
                    const label = sub.querySelector('label').textContent;
                    let score = 0;
                    
                    // 不同类型处理
                    if(sub.querySelector('.validity-group')) {
                        score = parseFloat(sub.querySelector('.weighted').value) || 0;
                    }
                    else if(sub.querySelector('.calculation-group')) {
                        score = parseFloat(sub.querySelector('[data-custom="weighted"]').value) || 0;
                    }
                    else {
                        score = parseFloat(sub.querySelector('[data-custom="weighted"]').value) || 0;
                    }
                    
                    subItems.push(`<div>${label}：${score.toFixed(2)}</div>`);
                    factorScore += score;
                });

                totalScore += factorScore;
                results.push(`
                    <div class="factor-result">
                        <h3>${factorName}</h3>
                        ${subItems.join('')}
                        <div style="margin-top:8px;font-weight:bold">小计：${factorScore.toFixed(2)}</div>
                    </div>
                `);
            });

            document.getElementById('factorScores').innerHTML = results.join('');
            document.getElementById('totalScore').innerHTML = `<h3 style="color:#2196F3">总评分：${totalScore.toFixed(2)}</h3>`;
        });

        // 导出Excel功能
        function exportToExcel() {
    const data = [['一级指标', '一级指标得分', '二级指标', '得分']]; // 表头
    const merges = [];
    let currentRow = 1; // 当前数据行（从表头下一行开始）

    document.querySelectorAll('.factor').forEach(factor => {
        const factorName = factor.querySelector('h2').textContent.trim();
        const subItems = factor.querySelectorAll('.subfactor');
        const level1Score = parseFloat(factor.querySelector('.total-box').textContent.replace('本指标得分：', '')) || 0;

        // 记录合并起始行
        const startRow = currentRow;

        // 添加首行（一级指标 + 得分 + 第一个二级指标）
        if(subItems.length > 0) {
            const firstSub = subItems[0];
            const subName = firstSub.querySelector('label').textContent.trim();
            const score = parseFloat(firstSub.querySelector('[data-custom="weighted"], .weighted').value) || 0;
            
            data.push([
                factorName,
                level1Score.toFixed(2),
                subName,
                score.toFixed(2)
            ]);
            currentRow++;
        }

        // 添加剩余二级指标（前两列留空）
        for(let i = 1; i < subItems.length; i++) {
            const sub = subItems[i];
            const subName = sub.querySelector('label').textContent.trim();
            const score = parseFloat(sub.querySelector('[data-custom="weighted"], .weighted').value) || 0;
            
            data.push(["", "", subName, score.toFixed(2)]);
            currentRow++;
        }

        // 设置合并范围（合并所有相关行）
        if(subItems.length > 0) {
            merges.push(
                { s: { r: startRow, c: 0 }, e: { r: currentRow - 1, c: 0 } }, // 合并一级指标列
                { s: { r: startRow, c: 1 }, e: { r: currentRow - 1, c: 1 } }  // 合并得分列
            );
        }
    });

    // 创建Excel工作表
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // 设置格式
    ws['!cols'] = [
        { wch: 30 }, // 一级指标
        { wch: 15 }, // 一级指标得分
        { wch: 30 }, // 二级指标
        { wch: 10 }  // 得分
    ];
    ws['!merges'] = merges;

    // 设置单元格样式（居中+自动换行）
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let R = range.s.r; R <= range.e.r; R++) {
        for(let C = range.s.c; C <= range.e.c; C++) {
            const cell = ws[XLSX.utils.encode_cell({r:R,c:C})];
            cell.s = {
                alignment: {
                    vertical: "center",
                    horizontal: "center",
                    wrapText: true
                }
            };
            // 加粗一级指标行
            if(R > 0 && data[R][0] !== ""){
                cell.s.font = { bold: true };
            }
        }
    }

    // 导出文件
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "评估结果");
    const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, "");
    XLSX.writeFile(wb, `整治得分_${dateStr}.xlsx`);
}

        // 跳转Deepseek
        function gotoDeepseek() {
            window.location.href = 'https://chat.deepseek.com/';
        }
    </script>
</body>
</html>
